<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Object Detection Data-path Processing Chain (DPC) for range HWA DPU only</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<table width=100%>
<tr>
  <td bgcolor="black" width="1"><a href="http://www.ti.com"><img border=0 src="../../tilogo.gif"></a></td>
  <td bgcolor="red"><img src="../../titagline.gif"></td>
</tr>
</table>
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Object Detection Data-path Processing Chain (DPC) for range HWA DPU only </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#objdetrangehwa_intro">Overview</a></li>
<li class="level1"><a href="#objdetrangehwa_appdpcFlow">Application-DPC Execution Flow</a></li>
<li class="level1"><a href="#objdetrangehwa_memory">Data Memory</a><ul><li class="level2"><a href="#objdetrangehwa_memCfg">Memory configuration</a></li>
<li class="level2"><a href="#objdetrangehwa_memPar">Memory partition</a></li>
<li class="level2"><a href="#objdetrangehwa_reconfig">DPU reconfiguration</a></li>
</ul>
</li>
<li class="level1"><a href="#objdetrangehwa_designNotes">Data Path Design Notes</a><ul><li class="level2"><a href="#objdetrangehwa_scaling">Scaling</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="objdetrangehwa_intro"></a>
Overview</h1>
<p>The Object detection DPC provides the functionality of processing ADC samples during the frame acquisition periods. It can be used by an application by registering with the DPM framework and invoked using DPM APIs. The external interface of this Object detection DPC can be seen at <a class="el" href="group___d_p_c___o_b_j_d_e_t_r_a_n_g_e_h_w_a___e_x_t_e_r_n_a_l.html">Object Detection DPC (Data-path Processing Chain) External</a></p>
<div class="image">
<img src="object_detection_datapath.png" alt="object_detection_datapath.png"/>
<div class="caption">
Object Detection Data Path Processing Chain</div></div>
<p> <br />
 <br />
 This data path chain processing consists of:</p><ul>
<li>Processing during the chirps as seen in the timing diagram:<ul>
<li>This consists of 1D (range) FFT processing using HWA that takes input from multiple receive antennas from the ADC buffer for every chirp (corresponding to the chirping pattern on the transmit antennas) and performs FFT on it and generates radar cube output into the L3 RAM in the format defined by <a class="elRef" doxygen="/home/gtbldadm/nightlybuilds/mmwave_sdk/ti/datapath/dpu/rangeproc/docs/rangeproc.tag:../../../../../../dpu/rangeproc/docs/doxygen/html/" href="../../../../../../dpu/rangeproc/docs/doxygen/html/group___d_p_i_f___r_a_d_a_r_c_u_b_e___f_o_r_m_a_t.html#ga4f1cc2e5019a697f3cafa1cecdf3b144">DPIF_RADARCUBE_FORMAT_1</a>. For more details of range processing, see the doxygen documentation of range processing DPU (Data Path Unit) located at <a class="elRef" doxygen="/home/gtbldadm/nightlybuilds/mmwave_sdk/ti/datapath/dpu/rangeproc/docs/rangeproc.tag:../../../../../../dpu/rangeproc/docs/doxygen/html/" href="../../../../../../dpu/rangeproc/docs/doxygen/html/index.html#dpu_range_intro">RangeProc DPU</a></li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="objdetrangehwa_appdpcFlow"></a>
Application-DPC Execution Flow</h1>
<p>Following diagram shows the application-DPC execution Flow.</p>
<div class="image">
<img src="dpc_flow.png" alt="dpc_flow.png"/>
<div class="caption">
Application-DPC Execution Flow</div></div>
<p> The flow above shows the sequencing of initialization, configuration, execution and dynamic control operations of the DPC and some level of detail of what happens under these operations. Most of the hardware resource (e.g HWA and EDMA related) configuration for the DPUs that is issued by the DPC as part of processing <a class="el" href="group___d_p_c___o_b_j_d_e_t_r_a_n_g_e_h_w_a___i_o_c_t_l_____c_o_m_m_a_n_d.html#ga2d4ab326f4fdfc7874959f3e2044cc2f">DPC_OBJDETRANGEHWA_IOCTL__STATIC_PRE_START_CFG</a> commands is provided by the application at build time using a resource file (DPC sources are built as part of building the application, there is no separate DPC library object). This file is passed as a compiler command line define </p><pre class="fragment">--define=APP_RESOURCE_FILE="fileName" </pre><p> The "fileName" above includes the path as if to include the file when building the the DPC sources as part of building the application, and any DPC source that needs to refer to this file (currently <a class="el" href="objdetrangehwa_8c.html">objdetrangehwa.c</a>) has the following code </p><pre class="fragment">#include APP_RESOURCE_FILE </pre><p> One of the demos that uses this DPC is located at ti/demo/xwr68xx/mmw. The resource file in this demo is mmw_res.h, this file shows all the definitions that are needed by the DPC from the application. This file is provided on compiler command line when building as follows: </p><pre class="fragment">--define=APP_RESOURCE_FILE="&lt;ti/demo/xwr68xx/mmw/mmw_res.h&gt;" </pre><h1><a class="anchor" id="objdetrangehwa_memory"></a>
Data Memory</h1>
<h2><a class="anchor" id="objdetrangehwa_memCfg"></a>
Memory configuration</h2>
<p>The configuration of L3 and Core Local RAM (hitherto referred in short as LRAM) memories are provided by the application</p><ul>
<li><a class="el" href="struct_d_p_c___object_detection_range_h_w_a___init_params__t.html#af966ff0a03db132346baf3f7b99b885b">DPC_ObjectDetectionRangeHWA_InitParams_t::L3ramCfg</a>,</li>
<li><a class="el" href="struct_d_p_c___object_detection_range_h_w_a___init_params__t.html#ac176a785bb18433e413eafeb1ab74b9a">DPC_ObjectDetectionRangeHWA_InitParams_t::CoreLocalRamCfg</a></li>
</ul>
<p>during <a class="el" href="group___d_p_c___o_b_j_d_e_t_r_a_n_g_e_h_w_a_____i_n_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#gab3688b470b396b17d361ff868aaaafe1">DPC_ObjectDetection_init</a> (invoked by application through <a class="elRef" doxygen="/home/gtbldadm/nightlybuilds/mmwave_sdk/ti/control/dpm/docs/dpm.tag:../../../../../../../control/dpm/docs/doxygen/html/" href="../../../../../../../control/dpm/docs/doxygen/html/group___d_p_m___e_x_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga4b9d232412d832c17c606c733792ab2c">DPM_init</a>).</p>
<p>This DPC reports L3RAM and radarCube memory usage back to application to be used by other DPCs (for details, refer to <a class="el" href="struct_d_p_c___object_detection_range_h_w_a__pre_start_cfg__radar_cube_mem__t.html">DPC_ObjectDetectionRangeHWA_preStartCfg_radarCubeMem_t</a> and <a class="el" href="struct_d_p_c___object_detection_range_h_w_a__pre_start_cfg__mem_usage__t.html">DPC_ObjectDetectionRangeHWA_preStartCfg_memUsage_t</a>)</p>
<h2><a class="anchor" id="objdetrangehwa_memPar"></a>
Memory partition</h2>
<p>The L3 and LRAM partition happens during the processing of <a class="el" href="group___d_p_c___o_b_j_d_e_t_r_a_n_g_e_h_w_a___i_o_c_t_l_____c_o_m_m_a_n_d.html#ga2d4ab326f4fdfc7874959f3e2044cc2f">DPC_OBJDETRANGEHWA_IOCTL__STATIC_PRE_START_CFG</a> command and is shown in the following figure. The allocation from application system heap (typically in LRAM) using the MemoryP_osal API is done during <a class="el" href="group___d_p_c___o_b_j_d_e_t_r_a_n_g_e_h_w_a_____i_n_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#gab3688b470b396b17d361ff868aaaafe1">DPC_ObjectDetection_init</a> (object instances of DPC and DPUs for all sub-frames) and during the processing of <a class="el" href="group___d_p_c___o_b_j_d_e_t_r_a_n_g_e_h_w_a___i_o_c_t_l_____c_o_m_m_a_n_d.html#ga38cd50d3db59944bda37ae9f47adc721">DPC_OBJDETRANGEHWA_IOCTL__STATIC_PRE_START_COMMON_CFG</a> command (range DPUs dc antenna coupling signature buffer that is unique for each sub-frame) is also shown in the figure.</p>
<div class="image">
<img src="memory_allocation.png" alt="memory_allocation.png"/>
<div class="caption">
Data memory allocation</div></div>
<p> The buffers labeled "windowBuffer" in the picture are allocated/generated during DPU configue time. The windowing coefficients will be copied to HWA internal memory, hence this is temporary use of the local memory.</p>
<h2><a class="anchor" id="objdetrangehwa_reconfig"></a>
DPU reconfiguration</h2>
<p>DPU reconfiguration is related to data path processing across sub-frames for advanced frame configuraiton. In such cases, reconfiguration is required when switching sub-frames because HWA and EDMA resources are overlapped across sub-frames. Note that the DPU's xxx_config API is a full configuration API beyond the HWA and EDMA resources configuration (e.g static and dynamic configuration) so restricting to the full configuration would imply that no sub-frame specific DPU instantiation is necessary. However, the code illustrates separate instances of DPUs for each sub-frame to demonstrate generality of the sub-frame solution, in the case where there may be specialized (partial) configuration APIs in an optimized implementation (that only configured the overlapped HWA and EDMA resources). The limiting to full configuration also means that all the code required to build the configuration structures of the DPUs during the pre-start config time either has to be repeated or alternatively, the configurations that were created during the pre-start config processing be saved and reused later. The latter path has been taken, all DPU configuration that is built during the pre-start processing is stored in separate storage, this can be located at <a class="el" href="struct_sub_frame_obj__t.html#a749f51451e6f4c638688ea69fac0ef34">SubFrameObj_t::rangeCfg</a>. However, parts of this reconfiguration that cannot be captured in this storage need to be repeated, namely, window generation (<a class="el" href="group___d_p_c___o_b_j_d_e_t_r_a_n_g_e_h_w_a_____i_n_t_e_r_n_a_l___f_u_n_c_t_i_o_n.html#ga687e94d0a63dce6c67d3ebb0c9594a93">DPC_ObjDetRangeHwa_GenRangeWindow</a>).</p>
<h1><a class="anchor" id="objdetrangehwa_designNotes"></a>
Data Path Design Notes</h1>
<h2><a class="anchor" id="objdetrangehwa_scaling"></a>
Scaling</h2>
<ol type="1">
<li>HWA FFT Scaling: The HWA uses 24-bit fixed point arithmetic for the data path processing. In order to prevent overflows in the FFT processing, the scaling factors have to be set appropriately in the HWA configuration. The HWA has up to 10 stages of processing with ability to scale by 1/2 for each stage.<ol type="a">
<li>1D processing: If the HWA's FFT scale is set to <img class="formulaInl" alt="$\frac{1}{2^k}$" src="form_0.png"/> where <img class="formulaInl" alt="$k$" src="form_1.png"/> is the combined value for (number of stages for which the scaling is enabled) and (right shift applied in output formatter) and input to the FFT were a pure tone at one of the bins, then the output magnitude of the FFT at that bin will be <img class="formulaInl" alt="$\frac{N}{2^k}$" src="form_2.png"/> ( <img class="formulaInl" alt="$N$" src="form_3.png"/> is the FFT order) times the input tone amplitude (because tone is complex, this implies that the individual real and imaginary components will also be amplified by a maximum of this scale). Because we do a Blackman window before the FFT, the overall scale is about 1/2.4 of the FFT scale. This means for example for 256 point FFT, the windowing + FFT scale will be <img class="formulaInl" alt="$\frac{106.7}{2^k}$" src="form_4.png"/>. For example k=2, this will be 26.7. Therefore, the ADC output when it is a pure tone should not exceed +/-2^15/26.7 = 1228 for the I and Q components (even though HWA is internally 24-bit, the FFT output is stored as 16-bit before 2D processing, hence 2^15). For example k=3, this will be 13.33. Therefore, the ADC output when it is a pure tone should not exceed +/-2^15/13.33 = 2458 for the I and Q components (even though HWA is internally 24-bit, the FFT output is stored as 16-bit before 2D processing, hence 2^15). So chosen value of 'k' can now be distributed between butterfly scaling and output divisor (right) shift using via <a class="el" href="struct_d_p_c___object_detection_range_h_w_a___static_cfg__t.html#a11ae807315a3a30287bbece8e4a082ef">DPC_ObjectDetectionRangeHWA_StaticCfg_t::rangeFFTtuning</a>. <br />
 Recommendation is to allow butterfly stages to grow to 24-bit without using scaling and apply scaling at appropriate butterfly stages using <a class="elRef" doxygen="/home/gtbldadm/nightlybuilds/mmwave_sdk/ti/datapath/dpu/rangeproc/docs/rangeproc.tag:../../../../../../dpu/rangeproc/docs/doxygen/html/" href="../../../../../../dpu/rangeproc/docs/doxygen/html/struct_d_p_u___range_proc_h_w_a___f_f_ttuning__t.html#a74d155ac4a0948fd129163e6a318fa56">DPU_RangeProcHWA_FFTtuning::numLastButterflyStagesToScale</a> only if there is a possibility of overflowing 24-bit at that particular stage and beyond. Next, to convert 24-bit to 16-bit, use <a class="elRef" doxygen="/home/gtbldadm/nightlybuilds/mmwave_sdk/ti/datapath/dpu/rangeproc/docs/rangeproc.tag:../../../../../../dpu/rangeproc/docs/doxygen/html/" href="../../../../../../dpu/rangeproc/docs/doxygen/html/struct_d_p_u___range_proc_h_w_a___f_f_ttuning__t.html#a2ddaa14f6132c3aa5d9a7aa3e49862f1">DPU_RangeProcHWA_FFTtuning::fftOutputDivShift</a> appropriately.<br />
 The XWR68xx EVM when presented with a strong single reflector reasonably close to it (with Rx dB gain of 30 dB in the chirp profile and ADC samples = 256) shows ADC samples to be a max of about 2000 and hence application could chose value of '3' for fftOutputDivShift and value of '0' for numLastButterflyStagesToScale.</li>
</ol>
</li>
<li>Scaling factors for the chain: See ti/datapath/dpc/objectdetection/common/docs/object_detection_data_scaling.xlsx </li>
</ol>
</div></div><!-- contents -->
<hr size="1"><small>
Copyright  2020, Texas Instruments Incorporated</small>
</body>
</html>
